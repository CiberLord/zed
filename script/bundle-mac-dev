#!/usr/bin/env bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è macOS .app bundle –∏–∑ —Å–æ–±—Ä–∞–Ω–Ω–æ–≥–æ –±–∏–Ω–∞—Ä–Ω–∏–∫–∞
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./script/bundle-mac-dev [–æ–ø—Ü–∏–∏]
#
# –û–ø—Ü–∏–∏:
#   -i, --icon <—Ç–∏–ø>    –ò–∫–æ–Ω–∫–∞: dev (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é), preview, nightly, stable
#   -n, --name <–∏–º—è>    –ò–º—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: "Zed Dev")
#   -o, --open          –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è
#   -I, --install       –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤ /Applications
#   -b, --build         –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º bundle
#   -h, --help          –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É

set -euo pipefail

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
ICON_TYPE="dev"
APP_NAME="Zed Dev"
OPEN_AFTER=false
INSTALL_AFTER=false
BUILD_BEFORE=false

# –ü–∞—Ä—Å–∏–Ω–≥ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
while [[ $# -gt 0 ]]; do
    case $1 in
        -i|--icon)
            ICON_TYPE="$2"
            shift 2
            ;;
        -n|--name)
            APP_NAME="$2"
            shift 2
            ;;
        -o|--open)
            OPEN_AFTER=true
            shift
            ;;
        -I|--install)
            INSTALL_AFTER=true
            shift
            ;;
        -b|--build)
            BUILD_BEFORE=true
            shift
            ;;
        -h|--help)
            echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [–æ–ø—Ü–∏–∏]"
            echo ""
            echo "–û–ø—Ü–∏–∏:"
            echo "  -i, --icon <—Ç–∏–ø>    –ò–∫–æ–Ω–∫–∞: dev, preview, nightly, stable (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: dev)"
            echo "  -n, --name <–∏–º—è>    –ò–º—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 'Zed Dev')"
            echo "  -o, --open          –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è"
            echo "  -I, --install       –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤ /Applications"
            echo "  -b, --build         –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º bundle"
            echo "  -h, --help          –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É"
            echo ""
            echo "–ü—Ä–∏–º–µ—Ä—ã:"
            echo "  $0                           # –°–æ–∑–¥–∞—Ç—å —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"
            echo "  $0 -o                        # –°–æ–∑–¥–∞—Ç—å –∏ –æ—Ç–∫—Ä—ã—Ç—å"
            echo "  $0 -b -o                     # –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å, —Å–æ–∑–¥–∞—Ç—å –∏ –æ—Ç–∫—Ä—ã—Ç—å"
            echo "  $0 -i stable -n 'My Zed'     # –°–∏–Ω—è—è –∏–∫–æ–Ω–∫–∞ –∏ —Å–≤–æ—ë –∏–º—è"
            echo "  $0 -I                        # –°–æ–∑–¥–∞—Ç—å –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤ /Applications"
            exit 0
            ;;
        *)
            echo -e "${RED}–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç: $1${NC}"
            exit 1
            ;;
    esac
done

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
cd "$PROJECT_ROOT"

# –í—ã–±–∏—Ä–∞–µ–º –∏–∫–æ–Ω–∫—É
case $ICON_TYPE in
    dev)
        ICON_FILE="crates/zed/resources/app-icon-dev@2x.png"
        ;;
    preview)
        ICON_FILE="crates/zed/resources/app-icon-preview@2x.png"
        ;;
    nightly)
        ICON_FILE="crates/zed/resources/app-icon-nightly@2x.png"
        ;;
    stable)
        ICON_FILE="crates/zed/resources/app-icon@2x.png"
        ;;
    *)
        echo -e "${RED}–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –∏–∫–æ–Ω–∫–∏: $ICON_TYPE${NC}"
        echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ: dev, preview, nightly, stable"
        exit 1
        ;;
esac

echo -e "${BLUE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
echo -e "${BLUE}‚ïë     üöÄ Zed Dev Bundle Creator          ‚ïë${NC}"
echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
echo ""

# –°–±–æ—Ä–∫–∞ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
if [ "$BUILD_BEFORE" = true ]; then
    echo -e "${YELLOW}üì¶ –°–æ–±–∏—Ä–∞–µ–º release –±–∏–ª–¥...${NC}"
    cargo build --release -p zed
    echo ""
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –±–∏–Ω–∞—Ä–Ω–∏–∫–∞
BINARY_PATH="target/release/zed"
if [ ! -f "$BINARY_PATH" ]; then
    echo -e "${RED}‚ùå –ë–∏–Ω–∞—Ä–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω: $BINARY_PATH${NC}"
    echo -e "${YELLOW}–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞: cargo build --release -p zed${NC}"
    echo -e "${YELLOW}–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–ª–∞–≥ -b –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–±–æ—Ä–∫–∏${NC}"
    exit 1
fi

APP_DIR="target/${APP_NAME}.app"

echo -e "${GREEN}üì± –°–æ–∑–¥–∞—ë–º: ${APP_NAME}.app${NC}"
echo -e "   –ò–∫–æ–Ω–∫–∞: $ICON_TYPE"
echo ""

# –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π bundle –µ—Å–ª–∏ –µ—Å—Ç—å
rm -rf "$APP_DIR"

# –°–æ–∑–¥–∞—ë–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É
mkdir -p "$APP_DIR/Contents/MacOS"
mkdir -p "$APP_DIR/Contents/Resources"

# –ö–æ–ø–∏—Ä—É–µ–º –±–∏–Ω–∞—Ä–Ω–∏–∫
echo -e "${YELLOW}‚Üí –ö–æ–ø–∏—Ä—É–µ–º –±–∏–Ω–∞—Ä–Ω–∏–∫...${NC}"
cp "$BINARY_PATH" "$APP_DIR/Contents/MacOS/zed"

# –°–æ–∑–¥–∞—ë–º –∏–∫–æ–Ω–∫—É
echo -e "${YELLOW}‚Üí –°–æ–∑–¥–∞—ë–º –∏–∫–æ–Ω–∫—É...${NC}"
ICONSET_DIR="$APP_DIR/Contents/Resources/AppIcon.iconset"
mkdir -p "$ICONSET_DIR"

sips -z 16 16     "$ICON_FILE" --out "$ICONSET_DIR/icon_16x16.png" 2>/dev/null
sips -z 32 32     "$ICON_FILE" --out "$ICONSET_DIR/icon_16x16@2x.png" 2>/dev/null
sips -z 32 32     "$ICON_FILE" --out "$ICONSET_DIR/icon_32x32.png" 2>/dev/null
sips -z 64 64     "$ICON_FILE" --out "$ICONSET_DIR/icon_32x32@2x.png" 2>/dev/null
sips -z 128 128   "$ICON_FILE" --out "$ICONSET_DIR/icon_128x128.png" 2>/dev/null
sips -z 256 256   "$ICON_FILE" --out "$ICONSET_DIR/icon_128x128@2x.png" 2>/dev/null
sips -z 256 256   "$ICON_FILE" --out "$ICONSET_DIR/icon_256x256.png" 2>/dev/null
sips -z 512 512   "$ICON_FILE" --out "$ICONSET_DIR/icon_256x256@2x.png" 2>/dev/null
sips -z 512 512   "$ICON_FILE" --out "$ICONSET_DIR/icon_512x512.png" 2>/dev/null
cp "$ICON_FILE" "$ICONSET_DIR/icon_512x512@2x.png"

iconutil -c icns "$ICONSET_DIR" -o "$APP_DIR/Contents/Resources/AppIcon.icns"
rm -rf "$ICONSET_DIR"

# –°–æ–∑–¥–∞—ë–º Info.plist
echo -e "${YELLOW}‚Üí –°–æ–∑–¥–∞—ë–º Info.plist...${NC}"
BUNDLE_ID=$(echo "$APP_NAME" | tr '[:upper:]' '[:lower:]' | tr ' ' '.')
cat > "$APP_DIR/Contents/Info.plist" << EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>CFBundleName</key>
    <string>${APP_NAME}</string>
    <key>CFBundleDisplayName</key>
    <string>${APP_NAME}</string>
    <key>CFBundleIdentifier</key>
    <string>dev.zed.${BUNDLE_ID}</string>
    <key>CFBundleVersion</key>
    <string>0.217.0</string>
    <key>CFBundleShortVersionString</key>
    <string>0.217.0-dev</string>
    <key>CFBundlePackageType</key>
    <string>APPL</string>
    <key>CFBundleExecutable</key>
    <string>zed</string>
    <key>CFBundleIconFile</key>
    <string>AppIcon</string>
    <key>LSMinimumSystemVersion</key>
    <string>10.15.7</string>
    <key>NSHighResolutionCapable</key>
    <true/>
    <key>LSApplicationCategoryType</key>
    <string>public.app-category.developer-tools</string>
    <key>NSSupportsAutomaticGraphicsSwitching</key>
    <true/>
</dict>
</plist>
EOF

echo ""
echo -e "${GREEN}‚úÖ –ì–æ—Ç–æ–≤–æ!${NC}"
echo ""
echo -e "   üì¶ ${BLUE}$APP_DIR${NC}"
echo ""

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞
if [ "$INSTALL_AFTER" = true ]; then
    echo -e "${YELLOW}‚Üí –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤ /Applications...${NC}"
    rm -rf "/Applications/${APP_NAME}.app"
    cp -r "$APP_DIR" "/Applications/"
    echo -e "${GREEN}‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤ /Applications/${APP_NAME}.app${NC}"
    echo ""
fi

# –û—Ç–∫—Ä—ã—Ç–∏–µ
if [ "$OPEN_AFTER" = true ]; then
    echo -e "${YELLOW}‚Üí –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ...${NC}"
    if [ "$INSTALL_AFTER" = true ]; then
        open "/Applications/${APP_NAME}.app"
    else
        open "$APP_DIR"
    fi
fi

echo -e "${BLUE}–ö–æ–º–∞–Ω–¥—ã:${NC}"
echo -e "  –û—Ç–∫—Ä—ã—Ç—å:     open \"$APP_DIR\""
echo -e "  –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å:  cp -r \"$APP_DIR\" /Applications/"

